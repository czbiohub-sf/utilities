---
output:
  github_document:
    html_preview: FALSE
editor_options: 
  chunk_output_type: console
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, echo = FALSE, message = FALSE, error = FALSE, warning = FALSE}
library(tidyverse)
```
# czb-util

A collection of scripts for common data management and processing tasks.

The provided pipelines are built using the [Viash framework](http://www.viash.io) on top of the 
Nextflow workflow system. For more information on Nextflow please visit the [Nextflow github page](https://github.com/nextflow-io/nextflow) 
and the [Nextflow read the docs page](https://www.nextflow.io/docs/latest/index.html).

## Requirements

- Install `Docker`, `Podman` or `Singularity`.
- Install `Nextflow`.

## Run versioned pipeline

These are instructions on how to launch a pipeline using the published code without cloning and using this repository.

### Running Cell Ranger Demux

```sh
nextflow \
  run https://github.com/czbiohub/utilities \
  -r 1.0.0 \
  -main-script workflows/demux_cellranger/main.nf \
  -resume \
  -latest \
  -with-docker \
  --id tiny_bcl \
  --input resources_test/cellranger_tiny_bcl/bcl \
  --sample_sheet resources_test/cellranger_tiny_bcl/bcl/sample_sheet.csv \
  --publishDir temp
```

### Running Cell Ranger Mapping

```sh
bin/nextflow \
  run https://github.com/czbiohub/utilities \
  -r 1.0.0 \
  -main-script workflows/mapping_cellranger/main.nf \
  -resume \
  -latest \
  -with-docker \
  --id tiny_fastq \
  --input resources_test/cellranger_tiny_fastq/cellranger_tiny_fastq \
  --reference resources_test/cellranger_tiny_fastq/cellranger_tiny_ref \
  --publishDir temp
```

## Setting up development environment

Run `bin/init` to set up Viash and Nextflow. 

Run `bin/viash_build` to build all components and Docker containers locally.

Run `bin/viash_build` to unit test all components.

Run any of the following scripts to integration test individual pipelines:

- `workflows/demux_cellranger/test/integration_test.sh`
- `workflows/mapping_cellranger/test/integration_test.sh`

## List of components

The results below were generated by running `bin/viash_build; bin/viash_test`.

```{r readyaml, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results='asis'}
# get viash to generate a yaml of all components
out <- processx::run(
  command = "bin/viash", args = c("ns", "list", "-p", "docker"),
)
comp_yamls <- yaml::read_yaml(text = out$stdout)
```

```{r yamlasdf, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results='asis'}
# format relevant information as a data frame
comp_df <- map_df(seq_along(comp_yamls), function(i) {
  ya <- comp_yamls[[i]]
  auths <- ya$functionality$authors
  maintainer <- auths[map_lgl(auths, function(aut) "maintainer" %in% aut$roles)] %>% 
    first()
  
  tibble(
    conf = ya$info$config,
    name = ya$functionality$name,
    namespace = ya$functionality$namespace %||% NA_character_,
    maintainer_name = maintainer$name %||% NA_character_,
    maintainer_email = maintainer$email %||% NA_character_,
    maintainer_account = maintainer$props$github %||% NA_character_,
    platform = ya$platform$type %||% NA_character_
  )
})
```

```{r readtsv, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results='asis'}
# read `project_test` results
test_results <- 
  read_tsv(".viash_log_test.tsv") %>% 
  group_by(namespace, name = functionality, platform) %>% 
  summarise(
    setup_succeeded = any(test_name == "build_executable" & exit_code == 0),
    num_tests = sum(exit_code[test_name != "build_executable"] >= 0),
    num_succeeds = sum(exit_code[test_name != "build_executable"] == 0),
    status_label = case_when(
      !setup_succeeded ~ "SETUP FAIL!",
      num_tests == 0 ~ "no tests",
      TRUE ~ paste0(num_succeeds, " out of ", num_tests)
    ),
    status_colour = case_when(
      !setup_succeeded ~ "red",
      num_tests == 0 ~ "orange", 
      num_tests != num_succeeds ~ "red",
      TRUE ~ "brightgreen"
    ),
    duration = sum(duration),
    .groups = "drop"
  )

# provide defaults for tests which did not finish (DNF)
fail_defaults <- tibble(
  setup_succeeded = FALSE,
  num_tests = 0L,
  num_succeeds = 0L,
  status_label = "DNF",
  status_colour = "red",
  duration = NA
)

dnf_fill <- comp_df %>% 
  select(namespace, name, platform) %>% 
  anti_join(test_results, by = c("namespace", "name", "platform")) %>% 
  crossing(fail_defaults)
```

```{r mdtable, echo = FALSE, warning = FALSE, error = FALSE, message = FALSE, results='asis'}
# combine info final markdown table
bind_rows(
  test_results,
  dnf_fill
) %>% 
  left_join(comp_df, by = c("namespace", "name", "platform")) %>% 
  arrange(namespace, name, platform) %>% 
  transmute(
    Namespace = namespace,
    Component = glue::glue("[{name}]({conf})"),
    Tests = paste0("![tests](https://img.shields.io/badge/tests-", status_label, "-", status_colour, ")"),
    Maintainer = ifelse(!is.na(maintainer_account), glue::glue("[{maintainer_account}](https://github.com/{maintainer_account})"), ifelse(!is.na(maintainer_name), maintainer_name, "")),
    `Duration (s)` = duration
  ) %>% 
  knitr::kable()
```
